<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö (Firebase Edition)</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #86efac; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #22c55e; }
        .view, .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .prose { line-height: 1.7; }
        .prose strong { font-weight: 600; }
        .prose em { font-style: italic; }
        /* Utility classes will be generated by Tailwind */
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-100 to-slate-50 p-4">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-xl">
            <div class="text-center mb-6">
              <div class="relative group w-24 h-24 mx-auto mb-4">
    <img id="login-logo-image" src="https://raw.githubusercontent.com/ProgrammerMuemai/ScienceScorekeepingSystem/main/logo.png" alt="School Logo" class="w-full h-full object-contain">
</div>
               <h2 id="auth-title" class="text-2xl font-bold text-green-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
               <p class="text-slate-500">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô</p>
           </div>
           <form id="auth-form">
            <div class="mb-4">
                <label for="email-input" class="block text-sm font-medium text-slate-700 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                <input type="email" id="email-input" placeholder="teacher@example.com" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
            </div>
            <div class="mb-4">
                <label for="password-input" class="block text-sm font-medium text-slate-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                <input type="password" id="password-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
            </div>
            
            <div class="flex justify-end items-center text-sm mb-4">
                <a href="#" id="forgot-password-link" class="font-medium text-green-600 hover:text-green-500">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?</a>
            </div>

            <p id="auth-error" class="text-red-500 text-sm text-center mb-4 h-5"></p>

            <button id="auth-submit-btn" type="submit" class="w-full bg-green-500 text-white py-2.5 rounded-lg font-semibold hover:bg-green-600 transition-colors shadow-md">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>

            <p class="text-center text-sm text-slate-500 mt-6">
                <span id="auth-mode-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?</span>
                <a href="#" id="auth-mode-switch" class="font-medium text-green-600 hover:text-green-500">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>
            </p>
        </form>
    </div>
</div>

<div id="app-container" class="hidden">
    <div class="min-h-screen flex flex-col">

        <header class="bg-gradient-to-b from-green-100 to-white shadow-sm p-4 md:p-6 sticky top-0 z-50">
            <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                   <div class="relative group">
    <img id="header-logo-image" src="https://raw.githubusercontent.com/ProgrammerMuemai/ScienceScorekeepingSystem/main/logo.png" alt="School Logo" class="w-[100px] h-auto cursor-pointer">
    <label for="logo-file-input" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity rounded-full cursor-pointer text-sm font-semibold">
        ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ
    </label>
</div>
<input type="file" id="logo-file-input" class="hidden" accept="image/png, image/jpeg, image/gif, image/svg+xml">
                    <div id="header-info" class="text-center md:text-left">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 items-center">
                   <div id="user-info" class="text-sm text-slate-600 mb-2 sm:mb-0 sm:mr-4"></div>
                   <div class="flex gap-3">
                       <button id="manage-subjects-btn" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 text-sm md:text-base bg-blue-500 text-white shadow-md scale-105">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" /></svg>
                           <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</span>
                       </button>
                       <button id="logout-btn" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 text-sm md:text-base bg-red-500 text-white shadow-md scale-105">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>
                           <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
                       </button>
                   </div>
               </div>
           </div>
       </header>

       <main class="flex-grow container mx-auto p-4 md:p-6">
        <div id="app-loader" class="text-center p-10">
            <p class="text-lg animate-pulse text-green-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase...</p>
        </div>
        <div id="app-content" class="hidden">
            <div class="bg-white p-4 rounded-xl shadow-md mb-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="subject-selector" class="text-lg font-semibold text-slate-700 mb-2 block">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</label>
                        <select id="subject-selector" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></select>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-lg font-semibold text-slate-700">‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                            <button id="manage-classes-btn" class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>
                                <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                            </button>
                        </div>
                        <div id="class-selector" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
                <div class="border-t border-slate-200 !mt-6 !mb-2"></div>
                <div>
                    <div class="mb-4">
                        <h2 class="text-lg font-semibold mb-2 text-slate-700">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</h2>
                        <div id="main-nav" class="flex flex-wrap gap-2 border-b-2 border-slate-100 pb-4">
                            <button data-view="scores" class="nav-button active-nav">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                            <button data-view="students" class="nav-button">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                            <button data-view="summary" class="nav-button">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="content-area">
                <div id="scores-view" class="view"></div>
                <div id="students-view" class="view hidden"></div>
                <div id="summary-view" class="view hidden"></div>
                <div id="welcome-message" class="text-center p-10 bg-white rounded-xl shadow-md">
                    <h2 class="text-2xl font-semibold text-green-600 mb-2">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö</h2>
                    <p class="text-slate-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                </div>
            </div>
        </div>
    </main>
</div>
</div>

<div id="modal-container" class="hidden">
    <div id="student-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h3 id="student-modal-title" class="text-xl font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            <form id="student-form">
                <input type="hidden" id="student-id-input">
                <div class="mb-4">
                    <label for="student-number-input" class="block text-sm font-medium text-slate-700 mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label>
                    <input type="number" id="student-number-input" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <div class="mb-6">
                    <label for="student-name-input" class="block text-sm font-medium text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input type="text" id="student-name-input" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <div id="item-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
            <form id="item-form">
                <div class="mb-4">
                    <label for="item-name-input" class="block text-sm font-medium text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                    <input type="text" id="item-name-input" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î‡∏ó‡∏µ‡πà 1" required>
                </div>
                <div class="mb-6">
                    <label for="item-max-score-input" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°</label>
                    <input type="number" id="item-max-score-input" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 text-sm md:text-base bg-green-500 text-white shadow-md scale-105">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                </div>
            </form>
        </div>
    </div>

    <div id="excel-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <h3 class="text-xl font-semibold mb-2">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å Excel</h3>
            <p class="text-sm text-slate-500 mb-4">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå .xlsx ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
            <input type="file" id="excel-file-input" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 mb-4" accept=".xlsx, .xls">
            <div id="excel-mapping-area" class="hidden"></div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="import-excel-btn" type="button" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 text-sm md:text-base bg-blue-500 text-white shadow-md scale-105 disabled:opacity-50" disabled>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
            </div>
            <h3 id="delete-modal-title" class="text-lg font-semibold text-slate-900">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
            <div class="mt-2"><p id="delete-modal-text" class="text-sm text-slate-500"></p></div>
            <div class="mt-6 flex justify-center gap-3">
                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition-colors w-24">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-delete-btn" type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors w-24">‡∏•‡∏ö</button>
            </div>
        </div>
    </div>
    
    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md text-center">
            <h3 id="info-modal-title" class="text-lg font-semibold text-slate-900 mb-2">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
            <p id="info-modal-text" class="text-sm text-slate-500 mb-6"></p>
            <button onclick="closeModal()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>
    
    <div id="manage-classes-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-backdrop">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
        <h3 class="text-xl font-semibold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
        <div class="mb-4">
            <h4 class="font-medium text-slate-700 mb-2">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
            <div id="class-list-container" class="space-y-2 max-h-60 overflow-y-auto border rounded-lg p-2"></div>
        </div>
        <form id="add-class-form" class="mt-6 border-t pt-4">
            <h4 class="font-medium text-slate-700 mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h4>
            <div class="flex gap-2">
                <input type="text" id="new-class-name-input" class="flex-grow px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ.4/8" required>
                <button type="submit" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 text-sm md:text-base bg-green-500 text-white shadow-md scale-105">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>
        </form>
        <div class="flex justify-end mt-6"><button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition-colors">‡∏õ‡∏¥‡∏î</button></div>
    </div>
</div>

<div id="manage-subjects-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-backdrop">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
        <h3 class="text-xl font-semibold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h3>
        <div class="mb-4">
            <h4 class="font-medium text-slate-700 mb-2">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
            <div id="subject-list-container" class="space-y-2 max-h-60 overflow-y-auto border rounded-lg p-2"></div>
        </div>
        <form id="add-subject-form" class="mt-6 border-t pt-4">
            <h4 class="font-medium text-slate-700 mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="new-subject-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå)" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input type="text" id="new-subject-code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ß14101)" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                <input type="text" id="new-teacher-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                <input type="text" id="new-school-info" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
            </div>
            <div class="mt-4"><button type="submit" class="px-2 py-2 rounded-lg font-medium transition-all duration-200 text-sm md:text-base bg-green-500 text-white shadow-md scale-105">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</button></div>
        </form>
        <div class="flex justify-end mt-6"><button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition-colors">‡∏õ‡∏¥‡∏î</button></div>
    </div>
</div>

</div>

<script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
            apiKey: "AIzaSyAz8rR7HgQiB5ivvKmxxAkRZM8NR0BI5dc", // This is safe to be public
            authDomain: "score-system-app.firebaseapp.com",
            projectId: "score-system-app",
            storageBucket: "score-system-app.firebasestorage.app",
            messagingSenderId: "739653865804",
            appId: "1:739653865804:web:406c278e75be0bf73e7fe9"
        };

    // --- FIREBASE INITIALIZATION ---
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    // --- APPLICATION STATE ---
    let state = {
        currentUser: null,
        currentSubject: null,
        currentClass: null,
        currentView: 'scores',
        subjects: {},
        sort: { key: 'total', direction: 'desc' },
        dbUnsubscribe: null 
    };
    
    // --- AUTHENTICATION STATE ---
    let authMode = 'login'; // Can be 'login' or 'signup'


    // --- DOM ELEMENTS ---
    const loginScreen = document.getElementById('login-screen');
    const appContainer = document.getElementById('app-container');
    const appLoader = document.getElementById('app-loader');
    const appContent = document.getElementById('app-content');
    const mainNav = document.getElementById('main-nav');
    const subjectSelector = document.getElementById('subject-selector');
    const classSelector = document.getElementById('class-selector');
    const views = { scores: document.getElementById('scores-view'), students: document.getElementById('students-view'), summary: document.getElementById('summary-view') };
    const welcomeMessage = document.getElementById('welcome-message');
    const modalContainer = document.getElementById('modal-container');
    
    // Auth form elements
    const authForm = document.getElementById('auth-form');
    const authTitle = document.getElementById('auth-title');
    const authSubmitBtn = document.getElementById('auth-submit-btn');
    const authModeSwitch = document.getElementById('auth-mode-switch');
    const authModeText = document.getElementById('auth-mode-text');
    const forgotPasswordLink = document.getElementById('forgot-password-link');
    const authError = document.getElementById('auth-error');

    // --- DATA PERSISTENCE (with Firestore) ---
    async function saveData() {
        if (!state.currentUser) return;
        const userDocRef = db.collection('users').doc(state.currentUser.uid);
        try {
            await userDocRef.set({ subjects: state.subjects });
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');
        } catch (error) {
            console.error("Error saving data to Firestore: ", error);
            openModal('info-modal', () => {
                document.getElementById('info-modal-title').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
                document.getElementById('info-modal-text').textContent = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`;
            });
        }
    }

    function loadDataAndListen() {
        if (state.dbUnsubscribe) state.dbUnsubscribe();
        
        const userDocRef = db.collection('users').doc(state.currentUser.uid);

        state.dbUnsubscribe = userDocRef.onSnapshot(doc => {
            appLoader.classList.add('hidden');
            appContent.classList.remove('hidden');

            if (doc.exists) {
                const data = doc.data();
                state.subjects = data.subjects || {};
                if (data.logoUrl) {
                    updateLogoImages(data.logoUrl);
                 } else {
                    updateLogoImages(null); // ‡πÉ‡∏ä‡πâ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô
            }


            } else {
                console.log("First time user, creating initial data structure.");
                state.subjects = {
                    '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏õ.4 (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)': {
                        details: {
                            subjectName: '‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå',
                            subjectCode: '‡∏ß14101',
                            teacherName: '‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π',
                            schoolInfo: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'
                        },
                        classes: ['‡∏õ.4/1'],
                        data: { '‡∏õ.4/1': { students: [], scoreItems: [], scores: {} } }
                    }
                };
                saveData();
            }

            if (!state.currentSubject && Object.keys(state.subjects).length > 0) {
                state.currentSubject = Object.keys(state.subjects)[0];
            }
            if (state.currentSubject && !state.currentClass) {
                state.currentClass = state.subjects[state.currentSubject]?.classes[0] || null;
            }
            
            render();
        }, error => {
            console.error("Error listening to data: ", error);
            appLoader.innerHTML = `<p class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
        });
    }
    
    /* --- UTILITIES, MODALS, RENDERERS --- */

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏•‡πÇ‡∏Å‡πâ ---
async function handleLogoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    if (!file.type.startsWith('image/')){
        openModal('info-modal', () => {
            document.getElementById('info-modal-title').textContent = '‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            document.getElementById('info-modal-text').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (png, jpg, gif, svg)';
        });
        return;
    }

    const userId = state.currentUser.uid;
    const storageRef = storage.ref(`logos/<span class="math-inline">\{userId\}/</span>{file.name}`);

    showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ...");

    try {
        const snapshot = await storageRef.put(file);
        const downloadURL = await snapshot.ref.getDownloadURL();

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL ‡πÉ‡∏ô Firestore
        await db.collection('users').doc(userId).set({ logoUrl: downloadURL }, { merge: true });

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        updateLogoImages(downloadURL);
        showToast("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");

    } catch (error) {
        console.error("Error uploading logo: ", error);
         openModal('info-modal', () => {
            document.getElementById('info-modal-title').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
            document.getElementById('info-modal-text').textContent = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÑ‡∏î‡πâ: ${error.message}`;
        });
    }
}

function updateLogoImages(url) {
    const defaultLogo = "https://raw.githubusercontent.com/ProgrammerMuemai/ScienceScorekeepingSystem/main/logo.png";
    const logoUrl = url || defaultLogo;
    document.getElementById('login-logo-image').src = logoUrl;
    document.getElementById('header-logo-image').src = logoUrl;
}


    function getNextStudentId() { let maxId = 0; Object.values(state.subjects).forEach(subject => { Object.values(subject.data).forEach(classData => { if (classData && classData.students) { classData.students.forEach(s => { if (s.id > maxId) maxId = s.id; }); } }); }); return maxId + 1; }
    function showToast(message) { const toast = document.createElement('div'); toast.className = 'fixed bottom-5 right-5 bg-green-600 text-white px-5 py-3 rounded-lg shadow-xl animate-bounce z-50'; toast.innerText = message; document.body.appendChild(toast); setTimeout(() => { toast.remove(); }, 3000); }
    function calculateTotalScore(studentId, classData) { if (!classData || !classData.scores) return 0; const studentScores = classData.scores[studentId] || {}; return Object.values(studentScores).reduce((sum, score) => sum + (Number(score) || 0), 0); }
    let currentModalId = null; let deleteCallback = null;
    function openModal(modalId, setupFn = null) { currentModalId = modalId; modalContainer.querySelectorAll('.fixed').forEach(m => m.classList.add('hidden')); const modal = document.getElementById(modalId); if (setupFn) setupFn(); modalContainer.classList.remove('hidden'); modal.classList.remove('hidden'); }
    function closeModal() { if (currentModalId) document.getElementById(currentModalId).classList.add('hidden'); modalContainer.classList.add('hidden'); currentModalId = null; deleteCallback = null; }
    function render() { if (!state.currentUser) return; renderSubjectSelector(); renderHeader(); renderClassSelector(); renderNav(); if (state.currentSubject && state.currentClass) { welcomeMessage.classList.add('hidden'); renderCurrentView(); } else { welcomeMessage.classList.remove('hidden'); Object.values(views).forEach(v => { v.innerHTML = ''; v.classList.add('hidden'); }); } }
   function renderHeader() {
        const headerInfo = document.getElementById('header-info');
        const subject = state.subjects[state.currentSubject];
        if (subject && subject.details) { // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö subject.details
            headerInfo.innerHTML = `
                <h1 class="text-xl md:text-2xl font-bold text-green-700">${subject.details.subjectName || '‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö'} (${subject.details.subjectCode || ''})</h1>
                <p class="text-sm md:text-base text-slate-600 font-medium">${subject.details.teacherName || '‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô'}</p>
                <p class="text-xs md:text-sm text-slate-500">${subject.details.schoolInfo || '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'}</p>
            `;
        } else {
            headerInfo.innerHTML = `<h1 class="text-xl md:text-2xl font-bold text-green-700">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h1>`;
        }
    }
    function renderSubjectSelector() { subjectSelector.innerHTML = ''; const subjectNames = Object.keys(state.subjects); if (subjectNames.length === 0) { subjectSelector.innerHTML = `<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>`; return; } subjectNames.forEach(name => { const option = document.createElement('option'); option.value = name; option.textContent = name; if (name === state.currentSubject) option.selected = true; subjectSelector.appendChild(option); }); }
    function renderClassSelector() { classSelector.innerHTML = ''; const subject = state.subjects[state.currentSubject]; if (!subject || !subject.classes || subject.classes.length === 0) { classSelector.innerHTML = `<p class="text-slate-500 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ</p>`; return; } subject.classes.forEach(className => { const button = document.createElement('button'); button.textContent = `${className}`; button.dataset.class = className; button.className = `px-4 py-2 rounded-lg font-medium transition-all duration-200 text-sm md:text-base ${state.currentClass === className ? 'bg-green-500 text-white shadow-md scale-105' : 'bg-green-100 text-green-800 hover:bg-green-200'}`; classSelector.appendChild(button); }); }
    function renderNav() { mainNav.querySelectorAll('.nav-button').forEach(button => { button.classList.toggle('active-nav', button.dataset.view === state.currentView); }); }
    function renderCurrentView() { if (!state.currentSubject || !state.currentClass || !state.subjects[state.currentSubject]?.data[state.currentClass]) { welcomeMessage.classList.remove('hidden'); Object.values(views).forEach(v => { v.innerHTML = ''; v.classList.add('hidden'); }); return; } Object.entries(views).forEach(([viewName, viewElement]) => { viewElement.classList.toggle('hidden', viewName !== state.currentView); if (viewName === state.currentView) { if (viewName === 'scores') renderScoresView(); else if (viewName === 'students') renderStudentsView(); else if (viewName === 'summary') renderSummaryView(); } }); }
   // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---

    function getCurrentClassData() { 
        return state.subjects[state.currentSubject]?.data[state.currentClass]; 
    }

    function renderStudentsView() { 
        const classData = getCurrentClassData(); 
        if (!classData) return; 
        const studentList = [...(classData.students || [])].sort((a,b) => a.number - b.number); 
        views.students.innerHTML = `
            <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-slate-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ä‡∏±‡πâ‡∏ô ${state.currentClass} (${studentList.length} ‡∏Ñ‡∏ô)</h2>
                    <div class="flex gap-3">
                        <button id="import-btn" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 text-sm md:text-base bg-green-500 text-white shadow-md scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                            <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å Excel</span>
                        </button>
                        <button id="add-student-btn" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 text-sm md:text-base bg-blue-500 text-white shadow-md scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</span>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="table-header w-20">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                <th class="table-header text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="table-header w-40">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${studentList.length > 0 ? studentList.map(s => `
                            <tr class="border-b border-slate-200">
                                <td class="table-cell text-center">${s.number}</td>
                                <td class="table-cell">${s.name}</td>
                                <td class="table-cell text-center">
                                    <button class="px-1 py-1 rounded-lg font-medium transition-all duration-200 text-sm md:text-sm bg-green-500 text-white shadow-md scale-105" onclick="handleEditStudent(${s.id})" class="edit-btn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                    <button class="px-1 py-1 rounded-lg font-medium transition-all duration-200 text-sm md:text-sm bg-red-500 text-white shadow-md scale-105" onclick="handleDeleteStudent(${s.id})" class="delete-btn">‡∏•‡∏ö</button>
                                </td>
                            </tr>`).join('') : `<tr><td colspan="3" class="text-center p-8 text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>`}
                        </tbody>
                    </table>
                </div>
            </div>`; 
        views.students.querySelector('#add-student-btn').addEventListener('click', () => openModal('student-modal', () => { document.getElementById('student-modal-title').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'; document.getElementById('student-form').reset(); document.getElementById('student-id-input').value = ''; })); 
        views.students.querySelector('#import-btn').addEventListener('click', () => openModal('excel-modal', () => { document.getElementById('excel-file-input').value = ''; document.getElementById('excel-mapping-area').innerHTML = ''; document.getElementById('import-excel-btn').disabled = true; document.getElementById('excel-mapping-area').classList.add('hidden'); })); 
    }

    function renderScoresView() { 
        const classData = getCurrentClassData(); 
        if (!classData) return; 
        const studentList = [...(classData.students || [])].sort((a,b) => a.number - b.number); 
        const scoreItems = classData.scoreItems || []; 
        views.scores.innerHTML = `
            <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-slate-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏ä‡∏±‡πâ‡∏ô ${state.currentClass}</h2>
                    <div class="flex gap-3">
                        <button id="add-item-btn" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 text-sm md:text-base bg-green-500 text-white shadow-md scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                            <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                        </button>
                        <button id="save-scores-btn" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 text-sm md:text-base bg-blue-500 text-white shadow-md scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM5 4a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" /></svg>
                            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white" id="score-table">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="table-header w-16">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                <th class="table-header text-left min-w-[200px]">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                ${scoreItems.map(item => `<th class="table-header text-center min-w-[150px] group relative">${item.name}<br><span class="text-xs font-normal text-slate-500">(‡πÄ‡∏ï‡πá‡∏° ${item.max})</span><button onclick="deleteScoreItem('${item.name}')" class="absolute top-1 right-1 bg-red-100 text-red-500 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button></th>`).join('')}
                                <th class="table-header w-28 bg-green-50">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${studentList.length > 0 ? studentList.map(s => `
                            <tr class="border-b border-slate-200">
                                <td class="table-cell text-center font-medium">${s.number}</td>
                                <td class="table-cell">${s.name}</td>
                                ${scoreItems.map(item => `<td class="table-cell text-center p-1"><input type="number" data-student-id="${s.id}" data-item-name="${item.name}" value="${classData.scores?.[s.id]?.[item.name] || ''}" max="${item.max}" min="0" class="w-20 text-center border rounded-md p-1 focus:outline-none focus:ring-2 focus:ring-green-400"></td>`).join('')}
                                <td id="total-score-${s.id}" class="table-cell text-center font-bold text-green-700 bg-green-50">${calculateTotalScore(s.id, classData)}</td>
                            </tr>`).join('') : `<tr><td colspan="${2 + scoreItems.length + 1}" class="text-center p-8 text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>`}
                        </tbody>
                    </table>
                </div>
            </div>`; 
        views.scores.querySelector('#add-item-btn').addEventListener('click', () => openModal('item-modal', () => document.getElementById('item-form').reset())); 
        views.scores.querySelector('#save-scores-btn').addEventListener('click', handleSaveScores); 
        views.scores.querySelectorAll('#score-table input[type="number"]').forEach(input => { 
            input.addEventListener('input', (e) => { 
                const studentRow = e.target.closest('tr'); 
                const totalCell = studentRow.querySelector(`[id^="total-score-"]`); 
                let currentTotal = 0; 
                studentRow.querySelectorAll('input[type="number"]').forEach(inp => { currentTotal += Number(inp.value) || 0; }); 
                totalCell.textContent = currentTotal; 
            }); 
        }); 
    }

    function renderSummaryView() { 
        const classData = getCurrentClassData(); 
        if (!classData) return; 
        const summaryData = (classData.students || []).map(s => ({ ...s, total: calculateTotalScore(s.id, classData) })).sort((a, b) => state.sort.direction === 'asc' ? a[state.sort.key] - b[state.sort.key] : b[state.sort.key] - a[state.sort.key]); 
        views.summary.innerHTML = `
            <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-slate-800">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏ä‡∏±‡πâ‡∏ô ${state.currentClass}</h2>
                    <button id="export-excel-btn" class="px-4 py-2 rounded-lg font-medium transition-all duration-200 text-sm md:text-base bg-green-500 text-white shadow-md scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.293a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        <span>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel</span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="table-header w-24">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
                                <th class="table-header w-24">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                <th class="table-header text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="table-header w-40 cursor-pointer" id="sort-total-btn">
                                    ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° <span>${state.sort.key === 'total' ? (state.sort.direction === 'desc' ? '‚ñº' : '‚ñ≤') : ''}</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            ${summaryData.length > 0 ? summaryData.map((s, index) => `
                            <tr class="border-b border-slate-200">
                                <td class="table-cell text-center">${index + 1}</td>
                                <td class="table-cell text-center">${s.number}</td>
                                <td class="table-cell">${s.name}</td>
                                <td class="table-cell text-center font-bold text-lg ${s.total > 25 ? 'text-green-600' : 'text-orange-500'}">${s.total}</td>
                            </tr>`).join('') : `<tr><td colspan="4" class="text-center p-8 text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>`}
                        </tbody>
                    </table>
                </div>
            </div>`; 
        views.summary.querySelector('#export-excel-btn').addEventListener('click', handleExportToExcel); 
        views.summary.querySelector('#sort-total-btn').addEventListener('click', handleSortSummary); 
    }

 function handleNavClick(e) { 
        if (e.target.matches('.nav-button')) { 
            state.currentView = e.target.dataset.view; 
            render(); 
        } 
    }

    // --- ‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---

    function renderManageSubjectsModal() {
        const container = document.getElementById('subject-list-container');
        container.innerHTML = '';
        const subjectNames = Object.keys(state.subjects);
        if (subjectNames.length > 0) {
            subjectNames.forEach(name => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-slate-100 p-2 rounded-md';
                div.innerHTML = `<span class="font-medium">${name}</span><button onclick="handleDeleteSubject('${name}')" class="delete-btn text-xs">‡∏•‡∏ö</button>`;
                container.appendChild(div);
            });
        } else { container.innerHTML = '<p class="text-slate-400 text-center p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</p>'; }
    }

    async function handleAddSubject(e) {
        e.preventDefault();
        const form = e.target;
        const subjectName = form.querySelector('#new-subject-name').value.trim();
        if (!subjectName) {
            openModal('info-modal', () => { 
                document.getElementById('info-modal-title').textContent = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; 
                document.getElementById('info-modal-text').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤'; 
            });
            return;
        }
        if (state.subjects[subjectName]) {
            openModal('info-modal', () => { 
                document.getElementById('info-modal-title').textContent = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô'; 
                document.getElementById('info-modal-text').textContent = '‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß'; 
            });
            return;
        }
        state.subjects[subjectName] = {
            details: {
                subjectName: `‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö ‡∏ß‡∏¥‡∏ä‡∏≤${subjectName}`,
                subjectCode: form.querySelector('#new-subject-code').value.trim(),
                teacherName: form.querySelector('#new-teacher-name').value.trim(),
                schoolInfo: form.querySelector('#new-school-info').value.trim()
            },
            classes: [],
            data: {}
        };
        await saveData();
        renderManageSubjectsModal();
        renderSubjectSelector();
        form.reset();
    }

    function handleDeleteSubject(subjectName) {
        openModal('confirm-delete-modal', () => {
            document.getElementById('delete-modal-title').textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤';
            document.getElementById('delete-modal-text').textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤ '${subjectName}' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£`;
            deleteCallback = async () => {
                delete state.subjects[subjectName];
                if (state.currentSubject === subjectName) {
                    const remainingSubjects = Object.keys(state.subjects);
                    state.currentSubject = remainingSubjects.length > 0 ? remainingSubjects[0] : null;
                    state.currentClass = state.currentSubject ? state.subjects[state.currentSubject].classes[0] || null : null;
                }
                await saveData();
                render();
                closeModal();
            };
        });
    }

    function renderManageClassesModal() {
        const container = document.getElementById('class-list-container');
        container.innerHTML = '';
        const subject = state.subjects[state.currentSubject];
        if (subject && subject.classes && subject.classes.length > 0) {
            subject.classes.forEach(className => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-slate-100 p-2 rounded-md';
                div.innerHTML = `<span class="font-medium">${className}</span><button onclick="handleDeleteClass('${className}')" class="delete-btn text-xs">‡∏•‡∏ö</button>`;
                container.appendChild(div);
            });
        } else { container.innerHTML = '<p class="text-slate-400 text-center p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ</p>'; }
    }

    async function handleAddClass(e) {
        e.preventDefault();
        const input = document.getElementById('new-class-name-input');
        const newClassName = input.value.trim();
        const subject = state.subjects[state.currentSubject];
        if (!subject) { return; }
        if (!newClassName) { return; }
        if (!subject.classes) subject.classes = [];
        if (subject.classes.includes(newClassName)) { return; }
        subject.classes.push(newClassName);
        if (!subject.data) subject.data = {};
        subject.data[newClassName] = { students: [], scoreItems: [], scores: {} };
        await saveData();
        renderManageClassesModal();
        renderClassSelector();
        input.value = '';
    }

    function handleDeleteClass(className) {
        openModal('confirm-delete-modal', () => {
            document.getElementById('delete-modal-title').textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
            document.getElementById('delete-modal-text').textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô '${className}' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£`;
            deleteCallback = async () => {
                const subject = state.subjects[state.currentSubject];
                subject.classes = subject.classes.filter(c => c !== className);
                delete subject.data[className];
                if (state.currentClass === className) { state.currentClass = subject.classes[0] || null; }
                await saveData();
                render();
                closeModal();
            };
        });
    }
    function handleClassClick(e) { if (e.target.matches('[data-class]')) { state.currentClass = e.target.dataset.class; render(); } }
    function handleSubjectChange(e) { state.currentSubject = e.target.value; const subjectData = state.subjects[state.currentSubject]; state.currentClass = subjectData?.classes[0] || null; render(); }
    document.getElementById('student-form').addEventListener('submit', (e) => { e.preventDefault(); const classData = getCurrentClassData(); if (!classData) return; const id = document.getElementById('student-id-input').value; const number = document.getElementById('student-number-input').value; const name = document.getElementById('student-name-input').value; if (id) { const student = classData.students.find(s => s.id == id); if (student) { student.number = parseInt(number); student.name = name; } } else { if (!classData.students) classData.students = []; classData.students.push({ id: getNextStudentId(), number: parseInt(number), name: name }); } saveData(); renderStudentsView(); closeModal(); });
    function handleEditStudent(studentId) { const student = getCurrentClassData().students.find(s => s.id === studentId); if (student) { openModal('student-modal', () => { document.getElementById('student-modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'; document.getElementById('student-id-input').value = student.id; document.getElementById('student-number-input').value = student.number; document.getElementById('student-name-input').value = student.name; }); } }
    function handleDeleteStudent(studentId) { const classData = getCurrentClassData(); const student = classData.students.find(s => s.id === studentId); if(student) { openModal('confirm-delete-modal', () => { document.getElementById('delete-modal-title').textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'; document.getElementById('delete-modal-text').textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö '${student.name}' ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢`; deleteCallback = () => { classData.students = classData.students.filter(s => s.id !== studentId); if (classData.scores) delete classData.scores[studentId]; saveData(); renderStudentsView(); closeModal(); }; }); } }
    function deleteScoreItem(itemName) { openModal('confirm-delete-modal', () => { document.getElementById('delete-modal-title').textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'; document.getElementById('delete-modal-text').textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô '${itemName}' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ`; deleteCallback = () => { const classData = getCurrentClassData(); classData.scoreItems = classData.scoreItems.filter(item => item.name !== itemName); Object.keys(classData.scores || {}).forEach(studentId => { delete classData.scores[studentId][itemName]; }); saveData(); renderScoresView(); closeModal(); }; }); }
    document.getElementById('confirm-delete-btn').addEventListener('click', () => { if (deleteCallback) deleteCallback(); });
    document.getElementById('item-form').addEventListener('submit', (e) => { e.preventDefault(); const classData = getCurrentClassData(); const name = document.getElementById('item-name-input').value; const max = document.getElementById('item-max-score-input').value; if (!classData.scoreItems) classData.scoreItems = []; if (classData.scoreItems.some(item => item.name === name)) { openModal('info-modal', () => { document.getElementById('info-modal-title').textContent = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô'; document.getElementById('info-modal-text').textContent = '‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô'; }); return; } classData.scoreItems.push({ name: name, max: parseInt(max) }); saveData(); renderScoresView(); closeModal(); });
    function handleSaveScores() { const classData = getCurrentClassData(); document.querySelectorAll('#score-table input[type="number"]').forEach(input => { const studentId = input.dataset.studentId; const itemName = input.dataset.itemName; const score = input.value; if (!classData.scores) classData.scores = {}; if (!classData.scores[studentId]) classData.scores[studentId] = {}; classData.scores[studentId][itemName] = score === '' ? null : Number(score); }); saveData(); }
    function handleSortSummary() { state.sort.direction = state.sort.direction === 'desc' ? 'asc' : 'desc'; renderSummaryView(); }
    let excelData = { headers: [], rows: [] }; document.getElementById('excel-file-input').addEventListener('change', (e) => { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = (event) => { const data = new Uint8Array(event.target.result); const workbook = XLSX.read(data, { type: 'array' }); const worksheet = workbook.Sheets[workbook.SheetNames[0]]; const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); excelData.headers = json[0] || []; excelData.rows = json.slice(1); document.getElementById('excel-mapping-area').innerHTML = `<p class="font-medium mb-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å:</p><div class="overflow-x-auto border rounded-lg mb-4 max-h-48"><table class="min-w-full text-sm"><thead id="excel-preview-header" class="bg-slate-50"><tr>${excelData.headers.map(h => `<th class="p-2 font-medium text-left">${h}</th>`).join('')}</tr></thead><tbody id="excel-preview-body">${excelData.rows.slice(0, 5).map(row => `<tr>${row.map(cell => `<td class="p-2 border-t">${cell}</td>`).join('')}</tr>`).join('')}</tbody></table></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label for="excel-map-number" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'</label><select id="excel-map-number" class="w-full px-3 py-2 border border-slate-300 rounded-lg">${excelData.headers.map((h, i) => `<option value="${i}">${h}</option>`).join('')}</select></div><div><label for="excel-map-name" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'</label><select id="excel-map-name" class="w-full px-3 py-2 border border-slate-300 rounded-lg">${excelData.headers.map((h, i) => `<option value="${i}">${h}</option>`).join('')}</select></div></div>`; document.getElementById('excel-mapping-area').classList.remove('hidden'); document.getElementById('import-excel-btn').disabled = false; }; reader.readAsArrayBuffer(file); });
    document.getElementById('import-excel-btn').addEventListener('click', () => { const classData = getCurrentClassData(); const numberIndex = document.getElementById('excel-map-number').value; const nameIndex = document.getElementById('excel-map-name').value; if (!classData.students) classData.students = []; excelData.rows.forEach(row => { const number = row[numberIndex]; const name = row[nameIndex]; if (number && name && !classData.students.some(s => s.number == number)) { classData.students.push({ id: getNextStudentId(), number: parseInt(number), name: String(name) }); } }); saveData(); renderStudentsView(); closeModal(); });
    function handleExportToExcel() { const classData = getCurrentClassData(); if (!classData || !classData.students) { showToast("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å"); return; } const exportData = classData.students.map(s => ({ '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà': s.number, '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': s.name, ...(classData.scoreItems || []).reduce((acc, item) => { acc[item.name] = classData.scores?.[s.id]?.[item.name] || 0; return acc; }, {}), '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°': calculateTotalScore(s.id, classData) })).sort((a,b) => a['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'] - b['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà']); const worksheet = XLSX.utils.json_to_sheet(exportData); const workbook = XLSX.utils.book_new(); const sanitizedClassName = state.currentClass.replace(/[\/\\?*[\]:]/g, '-'); const sheetName = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${sanitizedClassName}`; XLSX.utils.book_append_sheet(workbook, worksheet, sheetName); XLSX.writeFile(workbook, `‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô_${state.currentSubject}_${sanitizedClassName}.xlsx`); }

    /* AI Functions Removed */
    
    function handleLogout() { if (state.dbUnsubscribe) state.dbUnsubscribe(); auth.signOut(); }
    
    function updateAuthUI(mode) {
        authMode = mode;
        authError.textContent = ''; 

        if (mode === 'login') {
            authTitle.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            authSubmitBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            authModeText.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?';
            authModeSwitch.textContent = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
            forgotPasswordLink.style.display = 'block';
        } else { // signup mode
            authTitle.textContent = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
            authSubmitBtn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£';
            authModeText.textContent = '‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß?';
            authModeSwitch.textContent = '‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            forgotPasswordLink.style.display = 'none';
        }
    }

    async function handleAuthFormSubmit(e) {
        e.preventDefault();
        const email = document.getElementById('email-input').value;
        const password = document.getElementById('password-input').value;
        authError.textContent = '';

        try {
            if (authMode === 'login') {
                await auth.signInWithEmailAndPassword(email, password);
            } else {
                await auth.createUserWithEmailAndPassword(email, password);
            }
        } catch (error) {
            console.error(`${authMode} error:`, error.code, error.message);
            switch (error.code) {
                case 'auth/invalid-credential': // Updated for newer SDK versions
                case 'auth/invalid-login-credentials':
                    authError.textContent = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                    break;
                case 'auth/email-already-in-use':
                    authError.textContent = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
                    break;
                case 'auth/weak-password':
                    authError.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
                    break;
                case 'auth/invalid-email':
                    authError.textContent = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                    break;
                default:
                    authError.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
            }
        }
    }

    async function handleForgotPassword() {
        const email = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:");
        if (!email) return; 

        try {
            await auth.sendPasswordResetEmail(email);
            showToast("‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
        } catch (error) {
            console.error("Password reset error:", error);
            authError.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ";
        }
    }

    function startApp(user) {
        state.currentUser = user;
        document.getElementById('user-info').textContent = `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${user.email}`;
        
        loginScreen.classList.add('hidden');
        appContainer.classList.remove('hidden');
        appContent.classList.add('hidden');
        appLoader.classList.remove('hidden');

        loadDataAndListen();
        
        if (!appContainer.dataset.listenersAdded) {
            mainNav.addEventListener('click', handleNavClick);
            subjectSelector.addEventListener('change', handleSubjectChange);
            classSelector.addEventListener('click', handleClassClick);
            document.getElementById('manage-subjects-btn').addEventListener('click', () => openModal('manage-subjects-modal', renderManageSubjectsModal));
            document.getElementById('add-subject-form').addEventListener('submit', handleAddSubject);
            document.getElementById('manage-classes-btn').addEventListener('click', () => openModal('manage-classes-modal', renderManageClassesModal));
            document.getElementById('add-class-form').addEventListener('submit', handleAddClass);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('logo-file-input').addEventListener('change', handleLogoUpload);
            appContainer.dataset.listenersAdded = 'true';
        }
    }

    function resetApp() {
        if (state.dbUnsubscribe) state.dbUnsubscribe();
        Object.keys(state).forEach(key => {
            if(key === 'sort') state[key] = { key: 'total', direction: 'desc' };
            else if(key === 'currentView') state[key] = 'scores';
            else if(typeof state[key] === 'object' && state[key] !== null) state[key] = {};
            else state[key] = null;
        });

        updateAuthUI('login');
        updateLogoImages(null);
        loginScreen.classList.remove('hidden');
        appContainer.classList.add('hidden');
        authError.textContent = '';
    }
    
    function init() {
        const style = document.createElement('style');
        style.innerHTML = `
            .nav-button { @apply flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium transition-all duration-300 bg-slate-100 text-slate-700 hover:bg-slate-200; }
            .active-nav { @apply bg-green-500 text-white shadow-md transform scale-105 hover:bg-green-600; }
            .styled-btn { @apply flex items-center justify-center gap-2 px-4 py-2 text-white rounded-lg font-semibold shadow-md hover:shadow-lg transition-all duration-300 text-sm transform hover:-translate-y-0.5; }
            .table-header { @apply px-3 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider; }
            .table-cell { @apply px-3 py-3 whitespace-nowrap; }
            .edit-btn { @apply px-3 py-1 bg-yellow-100 text-yellow-800 text-sm font-medium rounded-md hover:bg-yellow-200; }
            .delete-btn { @apply px-3 py-1 bg-red-100 text-red-800 text-sm font-medium rounded-md hover:bg-red-200; }
            .ai-btn { @apply px-2 py-1 bg-violet-100 text-violet-800 text-sm font-medium rounded-md hover:bg-violet-200 transition-colors; }
        `;
        document.head.appendChild(style);

        authForm.addEventListener('submit', handleAuthFormSubmit);
        authModeSwitch.addEventListener('click', (e) => {
            e.preventDefault();
            const newMode = authMode === 'login' ? 'signup' : 'login';
            updateAuthUI(newMode);
        });
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            handleForgotPassword();
        });
        
        auth.onAuthStateChanged(user => {
            if (user) {
                startApp(user);
            } else {
                resetApp();
            }
        });
    }

    init();
</script>
</body>
</html>